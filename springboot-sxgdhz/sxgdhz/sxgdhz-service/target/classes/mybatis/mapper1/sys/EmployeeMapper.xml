<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="pers.zb.center.service.user.oracleDao.IEmployeeDao" >
  
  <!-- 查询员工信息 -->
  <select id="findCount" resultType="java.lang.Integer">
		SELECT count(*) FROM ssd_ems_hr_employeelist
		where 1=1
		<if test="employeeId != null">AND EMPLOYEEID = #{employeeId}</if>
  		<if test="employeeName != null">AND EMPLOYEENAME like '%${employeeName}%'</if>
  		<if test="orgId != null">AND ORGID = #{orgId}</if>
  </select>
  
  <!-- 查询员工信息 -->
  <select id="find" resultType="pers.zb.center.service.user.entity.sys.Employee">
	<![CDATA[
		SELECT * FROM (
			SELECT tt.*, ROWNUM AS rowno FROM (  
				SELECT 
    ]]>
    				KEYID,PWD, EMPLOYEEID, EMPLOYEENAME, EMPLOYEESEX, 
    				ORGID, DEPARTMENTID,
    				(SELECT ORGNAME FROM SSD_EMS_HR_ORGLIST WHERE KEYID=ORGID) ORGNAME,
    				ADMINFLAG, ONLINESTATE, RECENTTIME, LASTLOGINTIME, 
    				CREATETIME, FORECASTCODE,PHONENUMBER, EMAIL, INFOXCODE
		  		FROM ssd_ems_hr_employeelist t 
		  		WHERE 1=1
		  		<if test="employeeId != null">AND EMPLOYEEID = #{employeeId}</if>
		  		<if test="employeeName != null">AND EMPLOYEENAME like '%${employeeName}%'</if>
		  		<if test="orgId != null">AND ORGID = #{orgId}</if>
		   		ORDER BY ${sortName} ${sortOrder}
	<![CDATA[
			) tt
	        WHERE ROWNUM <= #{offset}+#{limit}
        ) table_alias
   		WHERE table_alias.rowno >= #{offset}+1
	]]>
  </select>
  <!-- 查询员工信息 -->
  <select id="findDetialById" resultType="pers.zb.center.service.user.entity.sys.Employee">
	  	SELECT KEYID,EMPLOYEEID, PWD, EMPLOYEENAME, EMPLOYEESEX, ORGID, DEPARTMENTID,
	  	(select d.departmentname from ssd_ems_hr_department d where d.keyid=DEPARTMENTID) as departmentname, ADMINFLAG
		,ONLINESTATE, RECENTTIME, LASTLOGINTIME, CREATETIME, FORECASTCODE,exp1,exp2,exp3,exp4,exp5 ,phonenumber,infoxcode,email 
		FROM SSD_EMS_HR_EMPLOYEELIST
		WHERE 1=1
		<if test="keyId!=null">
			AND KEYID = #{keyId}
		</if>
		<if test="employeeId!=null">
			AND EMPLOYEEID = '${employeeId}'
		</if>
  </select>
  <!-- 加密狗 -->
  <select id="findDetialByExp5" resultType="pers.zb.center.service.user.entity.sys.Employee" parameterType="java.util.Map">
  	select * from SSD_EMS_HR_EMPLOYEELIST where exp5=#{exp5,jdbcType=VARCHAR}
  </select>
  <!-- 查询机构的所有员工 -->
  <select id="findByOrg" resultType="pers.zb.center.service.user.entity.sys.Employee">
  	SELECT KEYID,EMPLOYEEID, PWD, EMPLOYEENAME, EMPLOYEESEX, ORGID,DEPARTMENTID,  ADMINFLAG
		,ONLINESTATE, RECENTTIME, LASTLOGINTIME, CREATETIME, FORECASTCODE,exp1,exp2,exp3,exp4,exp5,email 
		FROM SSD_EMS_HR_EMPLOYEELIST
		WHERE 1=1
		<if test="orgId != null">
			AND ORGID =#{orgId}
		</if>
  </select>
  
  <select id="findOrg" resultType="pers.zb.center.service.user.entity.sys.Orglist" parameterType="java.util.Map">
  	select * from ssd_ems_hr_orglist where keyid=#{orgid,jdbcType=INTEGER}
  </select>
  <!-- 批量查询员工信息 -->
  <select id="findByKeyIds" resultType="pers.zb.center.service.user.entity.sys.Employee" parameterType="java.util.List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 11:02:38 CST 2015.
    -->
    select KEYID,EMPLOYEEID, PWD, EMPLOYEENAME, EMPLOYEESEX, ORGID, ADMINFLAG, ONLINESTATE, 
	RECENTTIME, LASTLOGINTIME, CREATETIME, FORECASTCODE, PHONENUMBER, INFOXCODE,exp1,exp2,exp3,exp4,exp5,email   
    from SSD_EMS_HR_EMPLOYEELIST 
    where EMPLOYEEID in 
	<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
        #{item}
    </foreach>
  </select>
  
  <!-- 根据角色查询员工信息 -->
  <select id="findByRole" resultType="pers.zb.center.service.user.entity.sys.Employee" parameterType="java.util.Map" >
    select e.KEYID, e.EMPLOYEEID, e.PWD, e.EMPLOYEENAME, e.EMPLOYEESEX, e.ORGID, e.ADMINFLAG,
	e.ONLINESTATE, e.RECENTTIME, e.LASTLOGINTIME, e.CREATETIME, e.FORECASTCODE, e.PHONENUMBER, e.INFOXCODE,e.EMAIL,
    r.ROLECODE as EXP1 from SSD_EMS_HR_EMPLOYEELIST e
    left join SSD_EMS_HR_USERROLEBIND b on e.EMPLOYEEID = b.EMPLOYEEID
	left join SSD_EMS_HR_ROLE r on b.ROLEID = r.KEYID
    <where>
    	<if test="employeeId != null and employeeId != ''">
    		e.EMPLOYEEID = #{employeeId,jdbcType=VARCHAR}
    	</if>
    	<if test="roleCode != null and roleCode != ''">
    		AND r.ROLECODE = #{roleCode,jdbcType=VARCHAR}
    	</if>
    </where>
  </select>
  <!-- 根据角色查询员工信息 -->
  <select id="findEmpListByJob" resultType="pers.zb.center.service.user.entity.sys.Employee" parameterType="java.util.Map" >
    	select e.* from SSD_EMS_HR_EMPLOYEELIST e,SSD_EMS_DUTY_WORKDAILY w
    	where w.jobid=#{jobId} and w.empid = e.employeeid 
    	and w.workdate=to_char(SYSDATE,'YYYY-MM-DD')
  </select>
  <!-- 根据流程查询员工信息 -->
  <select id="findEmpListByProcess" resultType="pers.zb.center.service.user.entity.sys.Employee" parameterType="java.util.Map" >
    	select e.* from ssd_ems_alm_info i,ssd_ems_process_opt o ,
			ssd_ems_alm_task t,ssd_ems_hr_employeelist e
			where i.taskid=#{keyId} and o.optcode=i.processstatus 
			and o.orgid=t.orgid and o.sendmessageid=t.sendmessageid
			and t.nextprocess = o.processcode
			and t.createuser = e.employeeid
			order by i.keyid DESC
    	
  </select>
  <!-- 获取主班任务 -->
  <select id="findMainJobEmp" resultType="pers.zb.center.service.user.entity.sys.Empobj" >
  select e.employeeid,e.employeename,e.phonenumber,w.starttime,w.endtime from (
  select * from ssd_ems_duty_dpworkdaily y join ssd_ems_duty_dpjob t on y.jobid=t.keyid 
  and t.postcode=#{zhiban}  and y.workdate=to_char(sysdate,'yyyy-MM-dd')
  ) w join ssd_ems_hr_employeelist e on w.empid=e.employeeid
  
  </select>


  <!-- 根据流程查询员工信息 -->
  <select id="findEmpListByTask" resultType="pers.zb.center.service.user.entity.sys.Employee" parameterType="java.util.Map" >
    	select  e.keyid,e.employeeid, e.pwd, e.employeename, e.employeesex, e.orgid, e.adminflag
		,e.onlinestate, e.recenttime, e.lastlogintime, e.createtime, e.forecastCode,e.infoxcode,
		 e.phoneNumber,
		o.optname as exp1
		  from (select i.*
		          from SSD_EMS_ALM_INFO i,
		               (select i.processstatus, max(i.keyid) keyId
		                  from SSD_EMS_ALM_INFO       i,
		                       Ssd_Ems_Alm_Task       t,
		                       ssd_ems_process_opt    o,
		                       ssd_ems_process_manage m
		                 where t.keyid = #{keyId}
		                   and i.taskid = t.keyid
		                   and o.optcode = i.processstatus
		                   and o.optnext = 1
		                   and t.orgid = o.orgid
		                   and t.sendmessageid = o.sendmessageid
		                   and m.processcode = o.processcode
		                 group by i.processstatus) i1
		         where i.keyId = i1.keyId) i2,
		       Ssd_Ems_Alm_Task t,
		       ssd_ems_process_opt o,
		       ssd_ems_process_manage m,
		       ssd_ems_hr_employeelist e
		 where t.keyid = #{keyId}
		   and i2.taskId = t.keyid
		   and o.optcode = i2.processStatus
		   and t.orgid = o.orgid
		   and t.sendmessageid = o.sendmessageid
		   and m.processcode = o.processcode
		   and e.employeeid = i2.createUser
  </select>
  
  <!-- 添加员工信息 -->
  <insert id="add">
  	<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="keyId">  
	   SELECT SEQ_SSD_EMS_HR_EMPLOYEELIST.NEXTVAL as keyId FROM DUAL   
	</selectKey> 
    insert into SSD_EMS_HR_EMPLOYEELIST (keyId, EMPLOYEEID, PWD, 
      EMPLOYEENAME, EMPLOYEESEX, ORGID,DEPARTMENTID,
      ADMINFLAG, ONLINESTATE, RECENTTIME, 
      LASTLOGINTIME, CREATETIME,FORECASTCODE,PHONENUMBER,INFOXCODE,EMAIL)
    values (#{keyId}, #{employeeId}, #{pwd}, #{employeeName}, #{employeeSex}, #{orgId},#{departmentId}, 
      #{adminFlag}, #{onlineState}, SYSDATE, SYSDATE, SYSDATE, #{forecastCode},#{phoneNumber},#{infoxCode},#{email})
  </insert>
  
  <!-- 修改员工信息 -->
  <update id="update">
    update SSD_EMS_HR_EMPLOYEELIST
    <set >
      <if test="okPwd != null" >
        PWD = #{okPwd},
      </if>
      <if test="orgId != null" >
        orgId = #{orgId},
      </if>
      <if test="departmentId != null" >
        departmentId = #{departmentId},
      </if>
      <if test="employeeName != null" >
        EMPLOYEENAME = #{employeeName},
      </if>
      <if test="employeeSex != null" >
        EMPLOYEESEX = #{employeeSex},
      </if>
      <if test="adminFlag != null" >
        ADMINFLAG = #{adminFlag},
      </if>
      <if test="forecastCode != null" >
        FORECASTCODE = #{forecastCode},
      </if>
      <if test="phoneNumber != null" >
        PHONENUMBER = #{phoneNumber},
      </if>
      <if test="infoxCode != null" >
        INFOXCODE = #{infoxCode},
      </if>
      <if test="email != null" >
        EMAIL = #{email},
      </if>
      <if test="exp4 != null" >
        exp4 = #{exp4},
      </if>
      <if test="exp5 != null" >
        exp5 = #{exp5},
      </if>
    </set>
    where KEYID = #{keyId}
  </update>
    
  <!-- 删除员工信息 -->
  <delete id="delete">
    delete from SSD_EMS_HR_EMPLOYEELIST
    where KEYID in (${keyId})
  </delete>
</mapper>